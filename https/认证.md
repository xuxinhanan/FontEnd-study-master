> 「不验证通信方的身份，通信方的身份有可能是伪装的」。比如我要打开极客时间的官网，但是黑客通过 DNS 劫持将极客时间官网的 IP 地址替换成了黑客的 IP 地址，这样我访问的其实是黑客的服务器了，而对浏览器来说，它完全不知道现在访问的是个黑客的站点。



为此，需要通过权威机构 **「CA」**颁发的 **数字证书** 来对通信方进行认证。

![img](https://static001.geekbang.org/resource/image/77/af/77c852ff2202b2b7bb3299a96a0f4aaf.png?wh=1668*1160)



如图可以看出，引入数字证书后：

+ 服务器没有直接返回公钥给浏览器，而是返回了 **「数字证书」**，而公钥正是包含在数字证书中的
+ **在浏览器端多了一个证书验证的操作**，验证了证书之后，才继续后续流程



### 那么浏览器如何验证数字证书？

当浏览器向服务器发出请求时，服务器会返回数字证书给浏览器。浏览器接收到数字证书之后，会对数字证书进行验证。

+ 首先浏览器读取证书中相关的明文信息，采用 CA 签名时相同的 Hash 函数来计算并得到 **信息摘要 A**
+ 然后再利用对应 CA 的公钥解密签名数据，得到**信息摘要 B**；对比信息摘要 A 和信息摘要 B，如果一致，则可以确认证书是合法的，即证明了这个服务器是合法的；同时浏览器还会验证证书相关的域名信息、有效时间等信息。





### 那么如何申请数字证书？

我们先来看看如何向 CA 申请证书。比如极客时间需要向某个 CA 去申请数字证书，通常的申请流程分以下几步：

+ 首先极客时间需要准备一套私钥和公钥，私钥留着自己使用；
+ 然后极客时间向 CA 机构提交公钥、公司、站点等信息并等待认证，这个认证过程可能是收费的；
+ CA 通过线上、线下等多种渠道来验证极客时间所提供信息的真实性，如公司是否存在、企业是否合法、域名是否归属该企业等；
+ 如信息审核通过，CA 会向极客时间签发认证的数字证书，包含了极客时间的公钥、组织信息、CA 的信息、有效时间、证书序列号等，这些信息都是明文的，同时包含一个 CA 生成的**「数字签名」**。



### 如何防止数字证书被篡改——数字签名

我们把证书原本的内容生成一份“签名”，比对证书内容和签名是否一致就能判别是否被篡改。这就是数字证书的“防伪技术”，这里的“签名”就叫**「数字签名」**。

![数字签名的生成与验证](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/2017-06-11-ca.png)

[数字签名的生成与验证](https://cheapsslsecurity.com/blog/digital-signature-vs-digital-certificate-the-difference-explained/)

数字签名的生成过程：

+ 首先 CA 使用 **Hash 函数**来计算服务器提交的明文信息，并得出**信息摘要**；
+ 然后 CA 再使用它的私钥对信息摘要进行加密，加密后的密文就是 CA 颁给服务器的数字签名。

~~~
这样我们就可以通过 CA 公钥解密来验证是否是该 CA 颁发的
~~~



### 那么如何证明CA机构的公钥是可信的？

你们可能会发现上文中说到CA机构的公钥，我几乎一笔带过，“浏览器保有它的公钥”，这是个什么保有法？怎么证明这个公钥是否可信？

让我们回想一下数字证书到底是干啥的？没错，为了证明某公钥是可信的，即“该公钥是否对应该网站”，那CA机构的公钥是否也可以用数字证书来证明？没错，操作系统、浏览器本身会预装一些它们信任的根证书，如果其中会有CA机构的根证书，这样就可以拿到它对应的可信公钥了。

实际上证书之间的认证也可以不止一层，可以A信任B，B信任C，以此类推，我们把它叫做`信任链`或`数字证书链`。也就是一连串的数字证书，由根证书为起点，透过层层信任，使终端实体证书的持有者可以获得转授的信任，以证明身份。

另外，不知你们是否遇到过网站访问不了、提示需安装证书的情况？这里安装的就是根证书。说明浏览器不认给这个网站颁发证书的机构，那么你就得手动下载安装该机构的根证书（风险自己承担XD）。安装后，你就有了它的公钥，就可以用它验证服务器发来的证书是否可信了。

![img](https://pic2.zhimg.com/v2-04cd27f3f46388df2d8d70375c4ecac5_b.jpg)

[信任链](https://publib.boulder.ibm.com/tividd/td/TRM/GC32-1323-00/en_US/HTML/admin230.htm)

