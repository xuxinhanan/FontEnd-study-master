

# 0.è®¾è®¡æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³â€”â€”å°è£…å˜åŒ–

è¿™ä¸€ç‚¹ç›¸ä¿¡å¤§å®¶ä¸éš¾ç†è§£â€”â€”å¦‚æœè¯´æˆ‘ä»¬å†™ä¸€ä¸ªä¸šåŠ¡ï¼Œè¿™ä¸ªä¸šåŠ¡æ˜¯ä¸€æ½­æ­»æ°´ï¼Œåˆå§‹ç‰ˆæœ¬æ˜¯ 1.0ï¼Œ100 å¹´åè¿˜æ˜¯ 1.0ï¼Œä¸æ¥å—ä»»ä½•è¿­ä»£å’Œä¼˜åŒ–ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸šåŠ¡å‡ ä¹å¯ä»¥éšä¾¿å†™ã€‚åæ­£åªè¦å®ç°åŠŸèƒ½å°±è¡Œäº†ï¼Œå®Œå…¨ä¸éœ€è¦è€ƒè™‘å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§ã€‚

ä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸å‘ç”Ÿå˜åŒ–çš„ä»£ç å¯ä»¥è¯´æ˜¯ä¸å­˜åœ¨çš„ã€‚æˆ‘ä»¬èƒ½åšçš„åªæœ‰å°†è¿™ä¸ªå˜åŒ–é€ æˆçš„å½±å“**æœ€å°åŒ–** â€”â€” **å°†å˜ä¸ä¸å˜åˆ†ç¦»ï¼Œç¡®ä¿å˜åŒ–çš„éƒ¨åˆ†çµæ´»ã€ä¸å˜çš„éƒ¨åˆ†ç¨³å®š**ã€‚

è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±å«â€œå°è£…å˜åŒ–â€ï¼›è¿™æ ·çš„ä»£ç ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€è°“çš„â€œå¥å£®â€çš„ä»£ç ï¼Œå®ƒå¯ä»¥ç»å¾—èµ·å˜åŒ–çš„è€ƒéªŒã€‚è€Œè®¾è®¡æ¨¡å¼å‡ºç°çš„æ„ä¹‰ï¼Œå°±æ˜¯å¸®æˆ‘ä»¬å†™å‡ºè¿™æ ·çš„ä»£ç ã€‚

æ— è®ºæ˜¯åˆ›å»ºå‹ã€ç»“æ„å‹è¿˜æ˜¯è¡Œä¸ºå‹ï¼Œè¿™äº›å…·ä½“çš„è®¾è®¡æ¨¡å¼éƒ½æ˜¯åœ¨ç”¨è‡ªå·±çš„æ–¹å¼å»å°è£…ä¸åŒç±»å‹çš„å˜åŒ– â€”â€” åˆ›å»ºå‹æ¨¡å¼å°è£…äº†åˆ›å»ºå¯¹è±¡è¿‡ç¨‹ä¸­çš„å˜åŒ–ï¼Œæ¯”å¦‚ä¸‹èŠ‚çš„å·¥å‚æ¨¡å¼ï¼Œå®ƒåšçš„äº‹æƒ…å°±æ˜¯å°†åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹æŠ½ç¦»ï¼›ç»“æ„å‹æ¨¡å¼å°è£…çš„æ˜¯å¯¹è±¡ä¹‹é—´ç»„åˆæ–¹å¼çš„å˜åŒ–ï¼Œç›®çš„åœ¨äºçµæ´»åœ°è¡¨è¾¾å¯¹è±¡é—´çš„é…åˆä¸ä¾èµ–å…³ç³»ï¼›è€Œè¡Œä¸ºå‹æ¨¡å¼åˆ™å°†æ˜¯å¯¹è±¡åƒå˜ä¸‡åŒ–çš„è¡Œä¸ºè¿›è¡ŒæŠ½ç¦»ï¼Œç¡®ä¿æˆ‘ä»¬èƒ½å¤Ÿæ›´å®‰å…¨ã€æ›´æ–¹ä¾¿åœ°å¯¹è¡Œä¸ºè¿›è¡Œæ›´æ”¹ã€‚



# 1. è§‚å¯Ÿè€…æ¨¡å¼

> è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªç›®æ ‡å¯¹è±¡ï¼Œå½“è¿™ä¸ªç›®æ ‡å¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°ã€‚

![image-20220127110751274](https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220127110751274.png)



## å®ç°

è§‚å¯Ÿè€…æ¨¡å¼çš„å®ç°å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨å›è°ƒæ¨¡å¼ï¼Œå½“çŠ¶æ€å˜æ›´æ—¶ï¼Œè°ƒç”¨å›è°ƒé€šçŸ¥è§‚å¯Ÿè€…ã€‚

~~~js
class Subject {
  constructor() {
    this.observers = [];
  }

  attach(observer) {
    this.observers.push(observer);
  }

  detach(observer) {
    this.observers.forEach((item, i) => {
      if (item === observer) {
        this.observers.splice(i, 1);
      }
    });
  }

  notify() {
    this.observers.forEach((observer) => {
      observer.update(this);
    });
  }
}

class observer {
  constructor() {}

  update() {
    console.log("Observer update");
  }
}

/* ä½¿ç”¨ */
class subSubject extends Subject {
  constructor() {
    super();
    this.state = null;
    this.observers = [];
  }

  getState() {
    return this.state;
  }

  setState(newState) {
    this.state = newState;
    this.notify();
  }
}

class subObserver extends Observer {
  constructor() {
    super();
    this.state = null;
  }

  // é‡å†™ä¸€ä¸ªå…·ä½“çš„updateæ–¹æ³•
  update(subject) {
    this.state = subject.getState();
    this.work();
  }

  work() {
    console.log("state change callbackFn");
  }
}
~~~

## åº”ç”¨

å‡è®¾æˆ‘ä»¬æ‹¿åˆ°è¯·æ±‚å¾—åˆ°çš„æ•°æ®åï¼Œæœ‰å¤šä¸ªæ¨¡å—æ·»åŠ äº†å›è°ƒã€‚å¦‚æœä»€ä¹ˆéƒ½ä¸è€ƒè™‘å¯èƒ½ä¼šç›´æ¥è¿™æ ·å†™ï¼š

~~~js
// getAddress å¼‚æ­¥è¯·æ±‚
// æœ‰ä¸‰ä¸ªæ¨¡å— Aï¼ŒBï¼ŒC ä¾èµ–è¯·æ±‚çš„ç»“æœ

getAddress().then(res => {
  const address = res.address;
  A.update(address)
  B.next(address)
  C.change(address)
})
~~~

æ­¤æ—¶å¦‚æœå¤šäº†ä¸€ä¸ªæ¨¡å— `D` ï¼ŒåŒæ ·éœ€è¦æ‹¿åˆ°è¯·æ±‚ç»“æœåè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œæˆ‘ä»¬åªå¥½å»ç¿»è¯·æ±‚çš„ä»£ç æŠŠ `D` æ¨¡å—çš„è°ƒç”¨è¡¥ä¸Šã€‚

~~~js
getAddress().then(res => {
  const address = res.address;
  A.update(address)
  B.next(address)
  C.change(address)
  D.init(address)
})
~~~

å¯ä»¥çœ‹åˆ°å„ä¸ªæ¨¡å—å’Œè·å–åœ°å€æ¨¡å—è€¦åˆä¸¥é‡ï¼Œ`A`ã€`B`ã€`C` æ¨¡å—æœ‰å˜åŒ–æˆ–è€…æœ‰æ–°å¢æ¨¡å—ï¼Œéƒ½éœ€è¦æ·±å…¥åˆ°è·å–åœ°å€çš„ä»£ç å»ä¿®æ”¹ã€‚

æ ¹æ®è§‚å¯Ÿè€…æ¨¡å¼çš„æ€æƒ³ä»£ç å¯ä»¥è¿™æ ·å†™ï¼š

~~~js
const observers = []
// æ³¨å†Œè§‚å¯Ÿè€…
observers.push(A.update)
observers.push(B.next)
obervers.push(C.change)

getAddress().then(res => {
  const address = res.address;
  observers.forEach(update => update(address))
})
~~~

å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è§‚å¯Ÿè€…æ¨¡å¼çš„æ€æƒ³æˆ‘ä»¬å°†æ·»åŠ å›è°ƒçš„æ“ä½œè§£è€¦äº†å‡ºæ¥ã€‚





# 2. å‘å¸ƒè®¢é˜…æ¨¡å¼

è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œ`Subject` **ç›´æ¥è§¦åŠåˆ°è®¢é˜…è€…**ï¼ˆè‡ªå·±ç»´æŠ¤è§‚å¯Ÿè€…åˆ—è¡¨è¿›è¡Œæ³¨å†Œå’Œé€šçŸ¥ï¼‰ã€‚

![image-20220130170413954](https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220130170413954.png)

å‘å¸ƒè®¢é˜…æ¨¡å¼åˆ™æ˜¯**ä¸ç›´æ¥è§¦åŠåˆ°è®¢é˜…è€…ã€è€Œæ˜¯ç”±ç»Ÿä¸€çš„ç¬¬ä¸‰æ–¹æ¥å®Œæˆå®é™…çš„é€šä¿¡çš„æ“ä½œ**ã€‚

![image-20220130171806687](https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220130171806687.png)





## å®ç°ä¸€ä¸ªäº‹ä»¶æ€»çº¿ mitt / eventBus

mitt çš„ä½¿ç”¨ï¼š

1. åˆ›å»ºä¸€ä¸ª mitt

~~~js
import mitt from 'mitt'

const emitter = mitt()
~~~

2. è®¢é˜…äº‹ä»¶

```javascript
emitter.on('foo', callback)
```

3. å‘å¸ƒäº‹ä»¶

```javascript
// params æŒ‡äº‹ä»¶è¢«è§¦å‘æ—¶å›è°ƒå‡½æ•°æ¥æ”¶çš„å…¥å‚
emitter.emit('foo', params)
```



å‡½æ•°å¼å®ç°ï¼š

~~~js
function mitt() {
  const handlers = {};
  return {
    handlers,

    on(eventName, callback) {
      if (!handlers[eventName]) {
        handlers[eventName] = [];
      }
      handlers[eventName].push(callback);
    },

    emit(eventName, ...args) {
      if (handlers[eventName]) {
        handlers[eventName].slice().forEach((callback) => callback(...args));
      }
    },

    off(eventName, callback) {
      const handlersQueue = handlers[eventName];
      const index = handlersQueue.indexOf(callback);
      if (index !== -1) {
        handlersQueue.splice(index, 1);
      }
    },

    once(eventName, callback) {
      const onceCallback = (...args) => {
        callback(...args);
        this.off(eventName, onceCallback);
      };
      this.on(eventName, onceCallback);
    },
  };
}
~~~



ç±»å®ç°ï¼š

~~~js
class Mitt {
  constructor() {
    // handler æ˜¯ä¸€ä¸ªäº‹ä»¶å’Œå›è°ƒä¹‹é—´çš„æ˜ å°„è¡¨
    this.handlers = {};
  }

  // onæ–¹æ³•ç”¨äºå®‰è£…äº‹ä»¶ç›‘å¬å™¨
  on(eventName, callback) {
    if (!this.handlers[eventName]) {
      this.handlers[eventName] = [];
    }
    this.handlers[eventName].push(callback);
  }

  // emitæ–¹æ³•ç”¨äºè§¦å‘ç›®æ ‡äº‹ä»¶
  emit(eventName, ...args) {
    if (this.handlers[eventName]) {
      this.handlers[eventName].slice().forEach((callback) => callback(...args));
    }
  }

  // ç§»é™¤æŸä¸ªäº‹ä»¶å›è°ƒé˜Ÿåˆ—é‡Œçš„æŒ‡å®šå›è°ƒå‡½æ•°
  off(eventName, callback) {
    const handlers = this.handlers[eventName];
    const index = handlers.indexOf(callback);
    if (index !== -1) {
      handlers.splice(index, 1);
    }
  }

  // ä¸ºäº‹ä»¶æ³¨å†Œå•æ¬¡ç›‘å¬å™¨
  once(eventName, callback) {
    // å¯¹å›è°ƒå‡½æ•°è¿›è¡ŒåŒ…è£…ï¼Œä½¿å…¶æ‰§è¡Œå®Œæ¯•è‡ªåŠ¨è¢«ç§»é™¤
    const onceCallback = (...args) => {
      callback(...args);
      this.off(eventName, onceCallback);
    };
    this.on(eventName, onceCallback);
  }
}
~~~

## ä¸è§‚å¯Ÿè€…æ¨¡å¼å¯¹æ¯”

è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè§£å†³çš„å…¶å®æ˜¯æ¨¡å—é—´çš„è€¦åˆé—®é¢˜ï¼Œæœ‰å®ƒåœ¨ï¼Œå³ä¾¿æ˜¯ä¸¤ä¸ªåˆ†ç¦»çš„ã€æ¯«ä¸ç›¸å…³çš„æ¨¡å—ï¼Œä¹Ÿå¯ä»¥å®ç°æ•°æ®é€šä¿¡ã€‚ä½†è§‚å¯Ÿè€…æ¨¡å¼ä»…ä»…æ˜¯å‡å°‘äº†è€¦åˆï¼Œ**å¹¶æ²¡æœ‰å®Œå…¨åœ°è§£å†³è€¦åˆé—®é¢˜**â€”â€”è¢«è§‚å¯Ÿè€…å¿…é¡»å»ç»´æŠ¤ä¸€å¥—è§‚å¯Ÿè€…çš„é›†åˆï¼Œè¿™äº›è§‚å¯Ÿè€…å¿…é¡»å®ç°ç»Ÿä¸€çš„æ–¹æ³•ä¾›è¢«è§‚å¯Ÿè€…è°ƒç”¨ã€‚



å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œåˆ™æ˜¯å‘å¸ƒè€…å®Œå…¨ä¸ç”¨æ„ŸçŸ¥è®¢é˜…è€…ï¼Œä¸ç”¨å…³å¿ƒå®ƒæ€ä¹ˆå®ç°å›è°ƒæ–¹æ³•ï¼Œäº‹ä»¶çš„æ³¨å†Œå’Œè§¦å‘éƒ½å‘ç”Ÿåœ¨ç‹¬ç«‹äºåŒæ–¹çš„ç¬¬ä¸‰æ–¹å¹³å°ï¼ˆäº‹ä»¶æ€»çº¿ï¼‰ä¸Šã€‚åœ¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼ä¸‹ï¼Œå®ç°äº†å®Œå…¨åœ°è§£è€¦ã€‚



**ä½†è¿™å¹¶ä¸æ„å‘³ç€ï¼Œå‘å¸ƒ-è®¢é˜…æ¨¡å¼å°±æ¯”è§‚å¯Ÿè€…æ¨¡å¼â€œé«˜çº§â€ã€‚**åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬çš„æ¨¡å—è§£è€¦è¯‰æ±‚å¹¶éæ€»æ˜¯éœ€è¦å®ƒä»¬å®Œå…¨è§£è€¦ï¼Œå› æ­¤éœ€çµæ´»è¿ç”¨ã€‚







# 3. è¿­ä»£å™¨æ¨¡å¼

> åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œ**è¿­ä»£å™¨æ¨¡å¼**æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå…¶ä¸­è¿­ä»£å™¨ç”¨äºéå†å®¹å™¨å¹¶è®¿é—®å®¹å™¨ä¸­çš„å…ƒç´ ã€‚è¿­ä»£å™¨æ¨¡å¼å°†ç®—æ³•ä¸å®¹å™¨è§£è€¦ã€‚

1. ES6çš„è¿­ä»£å™¨æ˜¯æŒ‡å®ç°äº† Symbol.iterator æ–¹æ³•çš„å¯¹è±¡ï¼Œå½“ä½¿ç”¨ for..of å¾ªç¯æ—¶ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªè¿­ä»£å™¨â€”â€” ä¸€ä¸ªæœ‰ next æ–¹æ³•çš„å¯¹è±¡ã€‚

   å½“å¸Œæœ›è¿­ä»£è·å–ä¸‹ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå°±è°ƒç”¨ `next()` æ–¹æ³•ã€‚

   `next()` æ–¹æ³•è¿”å›çš„ç»“æœæ˜¯ `{done: Boolean, value: any}`ï¼Œå½“ `done=true` æ—¶ï¼Œè¡¨ç¤ºå¾ªç¯ç»“æŸã€‚

2. é€šè¿‡ç”Ÿæˆå™¨èƒ½ä½¿æˆ‘ä»¬èƒ½å¤Ÿå†™å‡ºæ›´çŸ­çš„è¿­ä»£ä»£ç ã€‚

   æ‰§è¡Œä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªè¿­ä»£å™¨ã€‚

ES5å®ç°ç”Ÿæˆå™¨ï¼š

~~~js
function generator(list) {
  let idx = 0;
  let len = list.length;
  return {
    next: function () {
      let done = idx >= len;
      let value = !done ? list[idx++] : undefined;
      return {
        done: done,
        value: value,
      };
    },
  };
}

let iterator = generator(["1", "2", "3"]);
console.log(iterator.next());
console.log(iterator.next());
console.log(iterator.next());
console.log(iterator.next());
~~~





# 4. ç­–ç•¥æ¨¡å¼

> ç­–ç•¥æ¨¡å¼ä½œä¸ºä¸€ç§è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼ŒæŒ‡å¯¹è±¡æœ‰æŸä¸ªè¡Œä¸ºï¼Œä½†æ˜¯åœ¨ä¸åŒçš„åœºæ™¯ä¸­ï¼Œè¯¥è¡Œä¸ºæœ‰ä¸åŒçš„å®ç°ç®—æ³•ã€‚æ¯”å¦‚æ¯ä¸ªäººéƒ½è¦â€œäº¤ä¸ªäººæ‰€å¾—ç¨â€ï¼Œä½†æ˜¯â€œåœ¨ä¸­å›½äº¤ä¸ªäººæ‰€å¾—ç¨â€å’Œâ€œåœ¨ç¾å›½äº¤ä¸ªäººæ‰€å¾—ç¨â€å°±æœ‰ä¸åŒçš„ç®—ç¨æ–¹æ³•ã€‚
>
> ç­–ç•¥æ¨¡å¼ï¼š
>
> - å®šä¹‰äº†ä¸€æ—ç®—æ³•ï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰ï¼›
> - å°è£…äº†æ¯ä¸ªç®—æ³•ï¼›
> - è¿™æ—çš„ç®—æ³•å¯äº’æ¢ä»£æ›¿ï¼ˆinterchangeableï¼‰ã€‚

## åœºæ™¯

è¿›å…¥ä¸€ä¸ªè¥é”€æ´»åŠ¨é¡µé¢ï¼Œä¼šæ ¹æ®åç«¯ä¸‹å‘çš„ä¸åŒ `type` ï¼Œå‰ç«¯é¡µé¢å±•ç¤ºä¸åŒçš„å¼¹çª—ã€‚å¯¹äºè¿™ä¸ªéœ€æ±‚ï¼Œå¯ä»¥æç‚¼å‡ºä»¥ä¸‹çŠ¶æ€æ˜ å°„è¡¨ã€‚

~~~
STYLE_TYPE.Reward - openMoneyPop()
STYLE_TYPE.Poster - openPosterPop()
STYLE_TYPE.Activity - openActivityPop()
STYLE_TYPE.Balance - openBalancePop()
STYLE_TYPE.Cash - openCashBalancePop()
~~~

äºæ˜¯æˆ‘ä»¬å¯ä»¥å¾ˆå¿«çš„å†™å‡ºä»¥ä¸‹ä»£ç å®Œæˆéœ€æ±‚ï¼š

~~~js
async getMainData() {
  try {
    const res = await activityQuery(); // è¯·æ±‚åç«¯æ•°æ®
    this.styleType = res.styleType;
    if (this.styleType === STYLE_TYPE.Reward) {
      this.openMoneyPop();
    }else if (this.styleType === STYLE_TYPE.Waitreward) {
      this.openShareMoneyPop();
    } else if (this.styleType === STYLE_TYPE.Poster) {
      this.openPosterPop();
    } else if (this.styleType === STYLE_TYPE.Activity) {
      this.openActivityPop();
    } else if (this.styleType === STYLE_TYPE.Balance) {
      this.openBalancePop();
    } else if (this?.styleType === STYLE_TYPE.Cash) {
      this.openCashBalancePop();
    }
  } catch (error) {
    log.error(MODULENAME, 'ä¸»æ¥å£å¼‚å¸¸', JSON.stringify(error));
  }
}
~~~

æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹è¿™ä¹ˆå†™ä»£ç ä¼šå¸¦æ¥ä»€ä¹ˆåæœï¼š

- é¦–å…ˆï¼Œå®ƒè¿èƒŒäº†â€œå•ä¸€åŠŸèƒ½â€åŸåˆ™ã€‚ä¸€ä¸ª function é‡Œé¢ï¼Œå¤„ç†äº†å››å¨é€»è¾‘ã€‚è¿™æ ·ä¼šå¸¦æ¥çš„ç³Ÿç³•åæœï¼šæ¯”å¦‚è¯´ä¸‡ä¸€å…¶ä¸­ä¸€è¡Œä»£ç å‡ºäº† Bugï¼Œé‚£ä¹ˆæ•´ä¸ª`getMainData`é€»è¾‘éƒ½ä¼šå´©åï¼›ä¸æ­¤åŒæ—¶å‡ºäº† Bug ä½ å¾ˆéš¾å®šä½åˆ°åº•æ˜¯å“ªä¸ªä»£ç å—åäº†äº‹ï¼›å†æ¯”å¦‚è¯´å•ä¸ªèƒ½åŠ›å¾ˆéš¾è¢«æŠ½ç¦»å¤ç”¨ç­‰ç­‰ã€‚
- ä¸ä»…å¦‚æ­¤ï¼Œå®ƒè¿˜è¿èƒŒäº†â€œå¼€æ”¾å°é—­â€åŸåˆ™ã€‚å³å®ç°â€œå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­â€çš„æ•ˆæœã€‚å‡å¦‚æœªæ¥æ–°å¢ä¸€ç§å¼¹çª—ç±»å‹çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ° `getMainData` å†…éƒ¨å»è¡¥ä¸€ä¸ª `else if`ã€‚

æ¥ä¸‹æ¥é‡‡ç”¨ç­–ç•¥æ¨¡å¼ä¼˜åŒ–ä»£ç ã€‚

æˆ‘ä»¬ä»”ç»†æƒ³æƒ³ï¼Œä¸Šé¢ç”¨äº†è¿™ä¹ˆå¤š if-elseï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯ä¸ºäº†æŠŠ `STYLE_TYPE-å¼¹çª—å‡½æ•°` è¿™ä¸ªæ˜ å°„å…³ç³»ç»™æ˜ç¡®ä¸‹æ¥ï¼Ÿé‚£ä¹ˆåœ¨ JS ä¸­ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ—¢èƒ½å¤Ÿæ—¢å¸®æˆ‘ä»¬æ˜ç¡®æ˜ å°„å…³ç³»ï¼ŒåŒæ—¶ä¸ç ´åä»£ç çš„çµæ´»æ€§çš„æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯**å¯¹è±¡æ˜ å°„**ï¼

~~~js
// ğŸ“ popTypes.js
import { SHARETYPE } from './constant';

/* å¯¹æ‰©å±•å¼€æ”¾ */
const popTypes = {
  /* å•ä¸€åŠŸèƒ½æ”¹é€ ï¼Œä¸€ä¸ªå‡½æ•°å¯¹åº”ä¸€ä¸ªåŠŸèƒ½ */
  [STYLE_TYPE.Reward]: function() {
    ...
  },
  [STYLE_TYPE.Waitreward]: function() {
    ...
  },
  [STYLE_TYPE.Poster]: function() {
    ...
  },
  [STYLE_TYPE.Activity]: function() {
    ...
  },
  [STYLE_TYPE.Balance]: function() {
    ...
  },
  [STYLE_TYPE.Cash]: function() {
    ...
  },
}

/* å¯¹ä¿®æ”¹å°é—­ */
export function openPop(type){
  return popTypes[type]();
}
~~~



```js
// ğŸ“ main.js
import { openPop } from './popTypes';

async getMainData() {
  try {
    const res = await activityQuery(); // è¯·æ±‚åç«¯æ•°æ®
    openPop(res.styleType);
  } catch (error) {
    log.error(MODULENAME, 'ä¸»æ¥å£å¼‚å¸¸', JSON.stringify(error));
  }
}
```



## æ€»ç»“

å½“å‡ºç°å¾ˆå¤š `if else` æˆ–è€… `switch` çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘æ˜¯å¦èƒ½ä½¿ç”¨ç­–ç•¥æ¨¡å¼äº†ã€‚

é€šè¿‡ç­–ç•¥æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè‡ƒè‚¿çš„ä»£ç ç²¾ç®€ã€‚å¹¶å®ç°æ›´å¥½çš„å¤ç”¨æ€§ã€‚



# 5. å•ä¾‹æ¨¡å¼

> **ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹**ï¼Œè¿™æ ·çš„æ¨¡å¼å°±å«åšå•ä¾‹æ¨¡å¼ã€‚

![image-20220206181649135](https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220206181649135.png)

ç”¨ES6æ¨¡æ‹Ÿä¸€ä¸‹ï¼š

~~~js
class Singleton {
  static getInstance() {
    if (!Singleton.instance) {
      Singleton.instance = new Singleton();
    }
    return Singleton.instance;
  }
}
~~~



## åœºæ™¯

### **Module**

é€šå¸¸çš„å•ä¾‹å¯¹è±¡å¯èƒ½ä¼šæ˜¯ä¸‹è¾¹çš„æ ·å­ï¼Œæš´éœ²å‡ ä¸ªæ–¹æ³•ä¾›å¤–ç•Œä½¿ç”¨ã€‚

```js
var Singleton = {
  method1: function () {
    // ...
  },
  method2: function () {
    // ...
  }
};
```

ä½†å¦‚æœ`Singleton` æœ‰ç§æœ‰å±æ€§ï¼Œå¯ä»¥å†™æˆä¸‹è¾¹çš„æ ·å­ï¼š

```js
var Singleton = {
  privateVar: 'æˆ‘æ˜¯ç§æœ‰å±æ€§',
  method1: function () {
    // ...
  },
  method2: function () {
    // ...
  }
};
```

ä½†æ­¤æ—¶å¤–ç•Œå°±å¯ä»¥é€šè¿‡ `Singleton` éšæ„ä¿®æ”¹ `privateVar` çš„å€¼ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©é—­åŒ…ï¼Œé€šè¿‡ `IIFE (Immediately Invoked Function Expression)` å°†ä¸€äº›å±æ€§å’Œæ–¹æ³•ç§æœ‰åŒ–ã€‚

```js
var myInstance = (function() {
  var privateVar = '';

  function privateMethod () {
    // ...
  }

  return { 
    method1: function () {
    },
    method2: function () {
    }
  };
})();
```

ä½†éšç€ `ES6 Module` çš„å‡ºç°ï¼Œæˆ‘ä»¬å¾ˆå°‘åƒä¸Šè¾¹é‚£æ ·å»å®šä¹‰ä¸€ä¸ªæ¨¡å—äº†ï¼Œè€Œæ˜¯é€šè¿‡å•æ–‡ä»¶ï¼Œä¸€ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹æˆä¸€ä¸ª**å•ä¾‹å¯¹è±¡**ã€‚

```js
// ğŸ“ singleton.js
const somePrivateState = []

function privateMethod () {
  // ...
}

export default {
  method1() {
    // ...
  },
  method2() {
    // ...
  }
}
```

ç„¶åä½¿ç”¨çš„æ—¶å€™ `import` å³å¯ã€‚

```js
// ğŸ“ main.js
import Singleton from './singleton.js'
// ...
```

å³ä½¿æœ‰å¦ä¸€ä¸ªæ–‡ä»¶ä¹Ÿ `import` äº†åŒä¸€ä¸ªæ–‡ä»¶ã€‚

```js
// ğŸ“ main2.js
import Singleton from './singleton.js'
```

ç”±äº`Module`çš„ç‰¹æ€§ï¼š**æ¨¡å—ä»£ç ä»…åœ¨ç¬¬ä¸€æ¬¡å¯¼å…¥æ—¶è¢«è§£æ**ï¼Œå› æ­¤è¿™ä¸¤ä¸ªä¸åŒæ–‡ä»¶çš„ `import`çš„`Singleton` æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚

é‚£å¦‚æœé€šè¿‡ `Webpack` å°† `ES6` è½¬æˆ `ES5` ä»¥åå‘¢ï¼Œè¿™ç§æ–¹å¼è¿˜ä¼šæ˜¯å•ä¾‹å¯¹è±¡å—ï¼Ÿ

ç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ `Webpack` æ‰“åŒ…çš„äº§ç‰©ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨äº† `IIFE` ï¼ŒåŒæ—¶å°†ç¬¬ä¸€æ¬¡ `import` çš„æ¨¡å—è¿›è¡Œäº†ç¼“å­˜ï¼Œç¬¬äºŒæ¬¡ `import` çš„æ—¶å€™ä¼šä½¿ç”¨ä¹‹å‰çš„ç¼“å­˜ã€‚å¯ä»¥çœ‹ä¸‹ `__webpack_require__` çš„å®ç°ï¼Œå’Œå•ä¾‹æ¨¡å¼çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚

```js
function __webpack_require__(moduleId) {
  var cachedModule = __webpack_module_cache__[moduleId];
  
  // å•ä¾‹æ¨¡å¼çš„åº”ç”¨
  if (cachedModule !== undefined) {
    return cachedModule.exports;
  }

  var module = (__webpack_module_cache__[moduleId] = {
    exports: {},
  });
  __webpack_modules__[moduleId](
    module,
    module.exports,
    __webpack_require__
  );
  return module.exports;
}
```

### Mitt äº‹ä»¶æ€»çº¿

~~~ts
export default function mitt<Events extends Record<EventType, unknown>>(
	all?: EventHandlerMap<Events>
): Emitter<Events> {
	type GenericEventHandler =
		| Handler<Events[keyof Events]>
		| WildcardHandler<Events>;
	all = all || new Map();

	return {
		all,

		on<Key extends keyof Events>(type: Key, handler: GenericEventHandler) {
			// ......
		},

		off<Key extends keyof Events>(type: Key, handler?: GenericEventHandler) {
			// ......
		},

		emit<Key extends keyof Events>(type: Key, evt?: Events[Key]) {
			// ......
	};
}
~~~

å¯ä»¥çœ‹åˆ°å®ƒç›´æ¥å°† `mitt` è¿™ä¸ªå‡½æ•°å¯¼å‡ºäº†ï¼Œå¦‚æœæ¯ä¸ªé¡µé¢éƒ½å„è‡ª `import` å®ƒï¼Œç„¶åé€šè¿‡ `mitt()` æ¥ç”Ÿæˆå¯¹è±¡ï¼Œé‚£å‘å¸ƒè®¢é˜…å°±ä¹±å¥—äº†ï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡äº†ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªæ¨¡å— / æ–‡ä»¶ï¼Œç„¶å `export` ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œå…¶ä»–é¡µé¢å»ä½¿ç”¨è¿™ä¸ªå¯¹è±¡å°±å®ç°å•ä¾‹æ¨¡å¼äº†ã€‚

~~~js
import mitt from 'mitt'

const emitter = mitt()
~~~

### å®ç°ä¸€ä¸ª Storage

> å®ç°Storageï¼Œä½¿å¾—è¯¥å¯¹è±¡ä¸ºå•ä¾‹ï¼ŒåŸºäº localStorage è¿›è¡Œå°è£…ã€‚å®ç°æ–¹æ³• setItem(key,value) å’Œ getItem(key)ã€‚

å•ä¾‹æ¨¡å¼æƒ³è¦åšåˆ°çš„æ˜¯ï¼Œ**ä¸ç®¡æˆ‘ä»¬å°è¯•å»åˆ›å»ºå¤šå°‘æ¬¡ï¼Œå®ƒéƒ½åªç»™ä½ è¿”å›ç¬¬ä¸€æ¬¡æ‰€åˆ›å»ºçš„é‚£å”¯ä¸€çš„ä¸€ä¸ªå®ä¾‹**ã€‚

è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå°±éœ€è¦æ„é€ å‡½æ•°**å…·å¤‡åˆ¤æ–­è‡ªå·±æ˜¯å¦å·²ç»åˆ›å»ºè¿‡ä¸€ä¸ªå®ä¾‹**çš„èƒ½åŠ›ã€‚æˆ‘ä»¬ç°åœ¨æŠŠè¿™æ®µåˆ¤æ–­é€»è¾‘å†™æˆä¸€ä¸ªé™æ€æ–¹æ³•(å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥å†™å…¥æ„é€ å‡½æ•°çš„å‡½æ•°ä½“é‡Œï¼‰ï¼š

~~~js
class Storage {
  static getInstance() {
    if (!Storage.instance) {
      Storage.instance = new Storage();
    }
    return Storage.instance;
  }
  getItem(key) {
    return localStorage.getItem(key);
  }
  setItem(key, value) {
    return localStorage.setItem(key, value);
  }
}
~~~

ES5ç‰ˆæœ¬ï¼š

~~~js
function StorageBase() {}

StorageBase.prototype.getItem = function (key) {
  return localStorage.getItem(key);
};
StorageBase.prototype.setItem = function (key, value) {
  return localStorage.setItem(key, value);
};

const Storage = (function () {
  let instance = null;
  return function () {
    if (!instance) {
      instance = new StorageBase();
    }
    return instance;
  };
})();
~~~

### å®ç°ä¸€ä¸ªå…¨å±€Modalå¼¹æ¡†



~~~html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>å•ä¾‹æ¨¡å¼å¼¹æ¡†</title>
</head>
<style>
    #modal {
        height: 200px;
        width: 200px;
        line-height: 200px;
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid black;
        text-align: center;
    }
</style>
<body>
    <button id="open">æ‰“å¼€å¼¹æ¡†</button>
    <button id="close">å…³é—­å¼¹æ¡†</button>
</body>
<script>
    // ES5å®ç°å•ä¾‹æ¨¡å¼
    const Modal = (function(){
        let modal = null;
        return function() {
            if(!modal) {
                modal = document.createElement('div');
                modal.innerHTML = 'æˆ‘æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„Modal';
                modal.id = 'modal';
                modal.style.display = 'none';
                document.body.appendChild(modal);
            }
            return modal;
        }
    })()

    document.getElementById('open').addEventListener('click', function(){
        const modal = new Modal();
        modal.style.display = 'block';
    })

    document.getElementById('close').addEventListener('click', function(){
        const modal = new Modal();
        if (modal) {
            modal.style.display = 'none';
        }
    })
</script>
</html>
~~~



















