数据包都是通过 IP 地址传输给接收方的。但由于 IP 地址是数字标识，难以记忆，所以基于这个需求又出现了一个服务，负责把域名和 IP 地址做一一映射关系。

:white_check_mark: 这套域名映射为 IP 的系统就叫做“**域名系统**”，简称 DNS。

---------

### DNS缓存

虽然核心的 DNS 系统遍布全球，服务能力很强也很稳定，但如果全世界的网民都往这个系统里挤，即使不挤瘫痪了，访问速度也会很慢。

所以在核心 DNS 系统之外，还有两种手段用来减轻域名解析的压力，并且能够更快地获取结果，基本思路就是**“缓存”[^3]**。



首先，许多大公司、网络运行商都会建立自己的 DNS 服务器[^2]，**作为用户 DNS 查询的代理，代替查询DNS。**这些本地服务器可以缓存之前的查询结果，如果已经有了记录，就无需再向根服务器发起查询，直接返回对应的 IP 地址。[^1] 



其次，**操作系统里也会对 DNS 解析结果做缓存**，如果你之前访问过“www.baidu.com”，那么下一次在浏览器里再输入这个网址的时候就不会再跑到 DNS 那里去问了，直接在操作系统里就可以拿到 IP 地址。



另外，**操作系统里还有一个特殊的“主机映射”文件**，通常是一个可编辑的文本，在 Linux 里是“/etc/hosts”，在 Windows 里是“C:\WINDOWS\system32\drivers\etc\hosts”，如果操作系统在缓存里找不到 DNS 记录，就会找这个文件。



有了上面的**本地 DNS 服务器**、**操作系统缓存 和 hosts 文件**就可以直接在本地或本机就能解决，不仅方便了用户，也减轻了各级 DNS 服务器的压力，效率就大大提升了。



### 域名的解析

DNS 的核心系统是一个三层的树状、分布式服务，基本对应域名的结构：

1. **根域名服务器**：管理顶级域名服务器，返回“com”“net”“cn”等顶级域名服务器的 IP 地址；
2. **顶级域名服务器**：管理各自域名下的权威域名服务器，比如 com 顶级域名服务器可以返回 apple.com 域名服务器的 IP 地址；
3. **权威域名服务器**：管理自己域名下主机的 IP 地址，比如 apple.com 权威域名服务器可以返回 www.apple.com 的 IP 地址。

![img](https://static001.geekbang.org/resource/image/e5/ac/e51df3245609880641043af65bba94ac.png?wh=3000*1681)



---------------

### 解析过程

有了这个系统以后，任何一个域名都可以在这个树形结构里 **从顶至下** 进行查询，就好像是把域名从右到左顺序走了一遍，最终就获得了域名对应的 IP 地址。

例如，你要访问“www.baidu.com”，就要进行下面的三次查询：

1. 访问根域名服务器，它会告诉你“com”顶级域名服务器的地址；
2. 访问“com”顶级域名服务器，它再告诉你”baidu.com“权威域名服务器的地址；
3. 最后访问”baidu.com“权威域名服务器，就得到了“www.baidu.com”的地址。



----------





### 加入 CDN 后

当 **使用了CDN** 时，DNS 服务器根据用户 IP 地址，将域名解析成相应节点的缓存服务器IP地址，实现用户就近访问。使用 CDN 服务的网站，只需将其域名解析权交给 CDN 的全局负载均衡（GSLB）设备，将需要分发的内容注入 CDN，就可以实现内容加速了。

![img](https://support.huaweicloud.com/productdesc-cdn/zh-cn_image_0000001129063959.png)



1. 当用户点击网站页面上的内容URL，经过**本地**DNS系统解析，DNS 系统会最终将域名的解析权交给 `CNAME` 指向的 CDN 专用 DNS 服务器。
2. CDN 的 DNS 服务器将 CDN 的**全局负载均衡设备** `IP` 地址返回用户。
3. 用户向 CDN 的全局负载均衡设备发起内容 URL 访问请求。
4. CDN 全局负载均衡设备根据用户 IP 地址，以及用户请求的内容URL，选择一台用户所属区域的区域负载均衡设备，告诉用户向这台设备发起请求。
5. 基于以下这些条件的综合分析之后，区域负载均衡设备会向全局负载均衡设备 **返回一台缓存服务器的IP地址**：
   - 根据用户 IP 地址，判断哪一台服务器距用户最近；
   - 根据用户所请求的 URL 中携带的内容名称，判断哪一台服务器上有用户所需内容；
   - 查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力。
6. 用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，而区域均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。





![img](https://support.huaweicloud.com/productdesc-cdn/zh-cn_image_0170805353.png)



















[^1]: 这些 DNS 服务器的数量要比核心系统的服务器多很多，而且大多部署在离用户很近的地方。比较知名的 DNS 有 Google 的“8.8.8.8”，Microsoft 的“4.2.2.1”，还有 CloudFlare 的“1.1.1.1”等等。
[^2]: 这些“野生”服务器被称为“非权威域名服务器”。
[^3]: 增加了缓存之后，DNS的解析流程就增加了一步从本地 DNS 服务器中查询的步骤。

